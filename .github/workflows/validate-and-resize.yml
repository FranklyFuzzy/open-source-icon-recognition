name: Validate and Auto-Resize Database Icons

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-resize:
    runs-on: ubuntu-latest
    
    permissions:
      # Need write permission to commit changes back to repository
      contents: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v3
      with:
        # Fetch all history so we can commit back
        fetch-depth: 0
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
    
    - name: Install dependencies
      run: |
        # Create a simple package.json if it doesn't exist
        if [ ! -f package.json ]; then
          echo '{"name":"icon-validator","version":"1.0.0","private":true}' > package.json
        fi
        # Install Sharp directly without requiring existing dependencies
        npm install --no-package-lock sharp
    
    - name: Install ImageMagick
      run: sudo apt-get update && sudo apt-get install -y imagemagick
      
    - name: Validate JSON databases
      run: node .github/scripts/validate-json.js
      
    - name: Validate and auto-resize icons
      id: validate_resize
      run: |
        node .github/scripts/validate-and-resize-icons.js
        echo "files_changed=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT
    
    # If PR, commit changes back to PR branch
    - name: Commit changes to PR
      if: |
        github.event_name == 'pull_request' && 
        steps.validate_resize.outputs.files_changed != '0'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git commit -m "Auto-resize icons to meet validation requirements" -m "Automatically resized icons to meet size and format requirements. Please review the changes."
        git push
    
    # If not PR (direct push to main), create PR with changes
    - name: Create PR with resized icons
      if: |
        github.event_name == 'push' && 
        github.ref == 'refs/heads/main' && 
        steps.validate_resize.outputs.files_changed != '0'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Auto-resize icons to meet validation requirements
        title: Auto-resize icons
        body: |
          This PR automatically resizes icons to meet size and format requirements:
          - Makes non-square images square
          - Resizes images to be between 32px and 256px (target 128px)
          - Ensures all images are proper PNG format
          
          Please review the changes.
        branch: auto-resize-icons
        base: main
